<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" rel="stylesheet">
<script src="https://cdn.rawgit.com/konvajs/konva/2.1.3/konva.min.js"></script>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
 <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
 <style>
     /*  Color Pattel style  */
    ul.my-new-list, ul.text-color-list {
        float: left;
        width: 100%;
        list-style: none;
    }
    ul.my-new-list .color_pattel , ul.text-color-list li {
      width: 20px;
      float: left;
      display: inline-block;
      height: 20px;
    }
    .canvas_container h3 {
        background: #d6cece;
        padding: 8px;
        text-align: center;
        font-size: 23px;
        margin-bottom: 12px;
    }
    ul.toolbar_list {
        float: left;
        width: 100%;
        list-style-type: none;
        margin: 0;
        padding: 0;
    }
    ul.toolbar_list li {
      float: left;
      width: 47%;
      font-size: 25px;
      border: 1px solid;
      border-radius: 5px;
      padding: 4px;
      margin: 0 4px 5px 0px;
    }
    ul.toolbar_list li:hover,  ul.toolbar_list li.active{
        background: #efe8e8;
    }
  </style>
 <script>
     /*    Konva canvas file   */
/*    Declare Global Variables    */
var gridSize = 25,                      // Grid Tile Size
    canvasWidth = 20,                   // Grid Width
    canvasHeight = 20,                  // Grid Height
    box,                                // Variable for rectangle element
    circle,                             // Variable for circle element
    text,                               // Variable for circle element
    mode = "pencil",                    // Variable for mode with default pencil
    stage,                              // Stage variable
    backgroundCanvas,                   // Main background canvas variable
    canvasGridLayer,                    // Grid canvas variable
    stageRect,                          // Main canvas rectangle variable
    isMouseDown = false,                // Set Mouse down property false
    canvasBgCPara,                      // Canvas Background Color code parameter
    gridStrokeCPara,                    // Grid Stroke Color code parameter
    gridShadowCPara,                    // Grid Stroke Color code parameter
    circleStrokeCPara,                  // Circle Stroke Color code parameter
    circleFillCPara,                    // Circle Fill Color code parameter
    textFillCPara,                      // Text color fill parameter
    json,                               // Json variable for final canvas output
    posStart,
    posNow,
    rectPoints = [];
/*
      =========================================================
      * canvasInit(Para1, Para2, Para3, Para3, Para4, Para5)
      * Canavs initiation function with 5 parameters
      * Para1 : Canvas Background Color code
      * Para2 : Grid Stroke Color code parameter
      * Para3 : Grid Stroke Color code parameter
      * Para4 : Circle Stroke Color code parameter
      * Para5 : Circle Fill Color code parameter
      =========================================================

*/
function canvasInit(canvasMainBgcolor,gridStrokeColor,gridShadowColor,circleStrokeColor,circleFillColor,textFillColor){

/*  create stage for main canvas  */
stage = new Konva.Stage({
    container: 'canvas',                  // Canvas container
    width: canvasWidth * gridSize,        // Canvas Width
    height: canvasHeight * gridSize       // Canvas Height
});

/*  Create Multiple Layers for stage  */

backgroundCanvas = new Konva.Layer();        // Layer1 for canvas main background
canvasGridLayer = new Konva.Layer();         //  a Layer2 for canvas Grid

/*  Layers creation ends here! */

/*  Create new group  */
var gridRectGroup = new Konva.Group();
var gridCircleGroup = new Konva.Group();
var gridTextGroup = new Konva.Group();
var gridcloneGroup = new Konva.Group({draggable: true});
var gridLineGroup = new Konva.Group();

/*  Layer1 work starts here! */
stageRect =  new Konva.Rect({
  x:0,
  y:0,
  width: canvasWidth * gridSize,
  height: canvasHeight * gridSize,
  fill: canvasMainBgcolor,
})
backgroundCanvas.add(stageRect);
/*  Layer1 work ends here! */
textFillCPara = textFillColor;
var textColor = "";
$(document).on('click','.text_color_pattel',function(){
    var textClr = $(this).data("colorcode");
    changeColor(textClr);
})
function changeColor(x)
{
  textFillColor = x;
}
/*  Layer2 Create a grid on canvas work starts here!*/

for (var ix = 0; ix < canvasWidth; ix++) {
    for (var iy = 0; iy < canvasHeight; iy++) {
      box = new Konva.Rect({
          x : ix * gridSize,
          y : iy * gridSize,
          width : gridSize ,
          height: gridSize,
          stroke: gridStrokeColor,
          strokeWidth: 0,
          lineJoin : 'round',
          shadowEnabled : true,
          shadowColor: gridShadowColor,
          shadowOffset: {  x: 3,   y: 3 },
          shadowOpacity: 1,
          filled : false,
          lineDraw : false,
      });
      circle = new Konva.Circle({
        x: box.attrs.x,
        y: box.attrs.y,
        radius: 2,
        stroke: circleStrokeColor,
        strokeWidth: 1,
      });
      gridRectGroup.add(box);                   // Add rectangle to group
      gridCircleGroup.add(circle);              // Add rectangle to group
    }
  }

// console.log(box)
/*   Change tool mode function starts here!   */
$(".canvas_tool").click(function(){
  $('.toolbar_list li').removeClass('active');
  $(this).addClass('active');
   mode = $(this).data('mode');
   if(mode == 'refresh')location.reload();
});

/*   Change tool mode function ends here!   */

// draw a rectangle to be used as the rubber area
var r2 = new Konva.Rect({x: 0, y: 0, width: 0, height: 0, stroke: 'red', dash: [2,2]})
r2.listening(false); // stop r2 catching our mouse events.
gridRectGroup.add(r2);

var selected_rect = [];

var points =[];
// var test =[];
/*    Fill Grid cell   */

canvasGridLayer.on('mousedown', function(evt)
{

  isMouseDown = true;
  if (isMouseDown)
  {
    box = evt.target;
    switch (mode)
    {
      case 'pencil':
           // stage.container().style.cursor = 'move';
           console.log(box)
           if(box.attrs.filled === false)
           {
             box.attrs.filled = true;
             box.shadowEnabled(false);
             text = new Konva.Text({
                 text: 'X',
                 x: box.attrs.x+5,
                 y: box.attrs.y+4,
                 fontFamily: 'sans-serif',
                 fontSize: gridSize,
                 fill: textFillColor,
                 fontStyle : 'normal',
                 filled : true,
                 fontSize: 18,
                 align: 'center'
             });
             box.height = text.getHeight();
             gridTextGroup.add(text);
             canvasGridLayer.draw();
           }
           else
           {
             var txt = evt.target;
             if(txt.className == "Text")
             {
               txt.destroy();
             }
             canvasGridLayer.draw();
             box.attrs.filled = false;
             box.shadowEnabled(true);
           }
      break;
      case 'eraser':
          if(box.attrs.filled === true)
          {
             if(evt.target.className === 'Text')
             {
                 evt.target.destroy();
                 box.attrs.filled = false;
                 box.shadowEnabled(true);
             }
          }
      canvasGridLayer.draw();
      break;
       case 'select_shape':
          startDrag({x: box.attrs.x, y: box.attrs.y})
       break;
       case 'back_stich':
           points=[];
           var secondX = nearest(evt.evt.layerX,box.attrs.x,box.attrs.x+gridSize);
           var secondY = nearest(evt.evt.layerY,box.attrs.y,box.attrs.y+gridSize);
           points.push(box.attrs.x,box.attrs.y,secondX,secondY)
           var line = new Konva.Line({
               points :points,
               stroke: '#000000',
               strokeWidth: 3,
               drawLine : true,
           });
           gridRectGroup.add(line);
           canvasGridLayer.draw();
           box.attrs.lineDraw = true;
       break;
       case 'toolText':
       console.log('text')
       break;
       default:
       // stage.container().style.cursor = 'pointer';
    }
  }
});
canvasGridLayer.on('mouseup',function(evt){
  isMouseDown= false
  box = evt.target;

  switch (mode)
  {
     case 'pencil':

     break;
     case 'eraser':
     break;
     case 'select_shape':
       updateDrag({x: box.attrs.x, y: box.attrs.y},true)
         var textList = canvasGridLayer.find("Text");

         $( textList ).each(function(key, val) {
           if(val.attrs.selected === 'selected')
           {
               var clonerect  = val.clone({x: val.attrs.x, y: val.attrs.y, name :'cloneRect'});
               gridcloneGroup.add(clonerect);
               canvasGridLayer.add(gridcloneGroup);
               $( selected_rect ).each(function(key, rect) {
                 if(rect.attrs.x+5 === val.attrs.x && rect.attrs.y+4 === val.attrs.y)
                 {
                   rect.attrs.filled = false;
                   rect.attrs.shadowEnabled = true;
                   rect.attrs.shadowColor = gridShadowColor;
                   rect.attrs.shadowOffset = {  x: 3,   y: 3 };
                   canvasGridLayer.draw();
                 }
                });
               val.destroy();
             }
         })
         r2.visible(true);
         mode = '';
         stage.draw();
     break;
     case 'back_stich':
         var line = canvasGridLayer.find("Line");
         line[line.length-1].attrs.drawLine = false;
     break;
     case 'toolText':
     break;
     default:
     // stage.container().style.cursor = 'pointer';
   }
})

canvasGridLayer.on('mousemove', function(evt) {
  if (isMouseDown)
  {
    box = evt.target;
    switch (mode)
    {
       case 'pencil':
            // stage.container().style.cursor = 'move';
            if(box.attrs.filled === false)
            {
                box.shadowEnabled(false);
                box.attrs.filled = true;
                text = new Konva.Text({
                    text: 'X',
                    x: box.attrs.x+5,
                    y: box.attrs.y+4,
                    fontFamily: 'sans-serif',
                    fontSize: gridSize,
                    fill: textFillColor,
                    fontStyle : 'normal',
                    filled : true,
                    fontSize: 18,
                    align: 'center'
                });
                box.height = text.getHeight();
                gridTextGroup.add(text);
                canvasGridLayer.draw();
            }
            if(box.className === 'Rect' && box.attrs.filled === true)
            {
                selected_rect.push(box);
            }
       break;
       case 'eraser':
           if(box.className === 'Rect' && box.attrs.filled === true)
           {
              var textList = canvasGridLayer.find("Text");
              $( textList ).each(function(key, val) {
                 val.on('mouseenter', function(evt) {
                   if(evt.target.className == 'Text')
                   {
                     evt.target.destroy();
                   }
                 });
             });
             box.attrs.filled = false;
             box.shadowEnabled(true);
           }
           canvasGridLayer.draw();
       break;
       case 'select_shape':
          updateDrag({x: box.attrs.x, y: box.attrs.y},false)
       break;
       case 'back_stich':

               var line = canvasGridLayer.find("Line");
               line[line.length-1].attrs.drawLine = true;
               if(line[line.length-1].attrs.drawLine === true)
               {
                   var secondX = nearest(evt.evt.layerX,box.attrs.x,box.attrs.x+gridSize);
                   var secondY = nearest(evt.evt.layerY,box.attrs.y,box.attrs.y+gridSize);
                   if ( ((secondX - evt.evt.layerX) < 6) && ((secondX - evt.evt.layerX) > 0)) {
                     points.push(secondX,secondY);
                   }
                   else if(((secondY - evt.evt.layerY) < 6) && ((secondY - evt.evt.layerY) > 0)){
                     points.push(secondX,secondY);
                   }
                   line[line.length-1].points(points);
                   canvasGridLayer.draw();
                   line[line.length-1].attrs.drawLine = true;
               }
       break;
       case 'toolText':
       break;
       default:
       // stage.container().style.cursor = 'pointer';
    }
  }
});


/*  Code for the select and drag designs starts here!  */
gridcloneGroup.on('dragstart', function(e) {
    r2.visible(false);
});
gridcloneGroup.on('dragend', function() {
  gridcloneGroup.position({
    x: Math.round(gridcloneGroup.x() / gridSize) * gridSize,
    y: Math.round(gridcloneGroup.y() / gridSize) * gridSize
  });
  stage.batchDraw();
  gridcloneGroup.draggable(false)
});

function updateDrag(posIn,updateSelect){
  // update rubber rect position
   posNow = {x: posIn.x, y: posIn.y};
   var posRect = reverse(posStart,posNow);
   r2.x(posRect.x1);
   r2.y(posRect.y1);
   r2.width(posRect.x2 - posRect.x1);
   r2.height(posRect.y2 - posRect.y1);
   r2.visible(true);
   if(updateSelect == true){
     var textList = canvasGridLayer.find("Text");
     $( textList ).each(function(key, val) {
       if(val.attrs.x >= r2.attrs.x && val.attrs.x < (r2.attrs.x+r2.attrs.width) && val.attrs.y >= r2.attrs.y && val.attrs.y < (r2.attrs.y+r2.attrs.height)){
         val.attrs.selected = 'selected';
       }
     })
     rectPoints.push(posNow);
   }
   stage.draw(); // redraw any changes.
}
/*  Code for the select and drag designs ends here! */


/*  Layer2 Create a grid on canvas work ends here!*/
canvasGridLayer.add(gridRectGroup,gridCircleGroup,gridTextGroup,gridLineGroup);   // Add Groups to layer
stage.add(backgroundCanvas,canvasGridLayer);          // Add Layer to stage
json = stage.toJSON();      // Save entire canvas as json



/* Text popup starts here    */

  $("#textModal").draggable({
  handle: ".modal-header"
  });

    /*  Text field value on keyup  */
    $("#textfill").keyup(function() {
      updateSample($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),$('#myRange').val())
      updateSample1($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),$('#myRange').val())
    });

    /* Text font family value on change  */
    $('#textFontSelect').change(function(){
        updateSample($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),$('#myRange').val())
        updateSample1($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),$('#myRange').val())
    });

    /* Text Font size value on change  */
    $('#textFontsize').change(function(){
        updateSample($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),$('#myRange').val())
        updateSample1($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),$('#myRange').val())
    });
    /* Text Font Bold value on change  */
    $('#textFontBold').change(function(){
        updateSample($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),$('#myRange').val())
        updateSample1($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),$('#myRange').val())
    });
    /* Text Font Italic value on change  */
    $('#textFontItalic').change(function(){
        updateSample($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),$('#myRange').val())
        updateSample1($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),$('#myRange').val())
    });

    var slider = document.getElementById("myRange");
    var output = document.getElementById("demo");
    output.innerHTML = slider.value;
    slider.oninput = function() {
      output.innerHTML = this.value;
      updateSample($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),this.value)
      updateSample1($("#textfill").val(),$('#textFontSelect').val(),$('#textFontsize').val(),$("#textFontBold").prop("checked"), $("#textFontItalic").prop("checked"),this.value)
    }

    // CREATE KONVE STAGE AND LAYER
    var updateSampleStage = new Konva.Stage({
     container: 'textSample',
     width: 450,
     height: 200
    });

    updateSampleStage.getContainer().style.border = '1px solid grey';
    var updateSampleLayer = new Konva.Layer();
    updateSampleStage.add(updateSampleLayer);
    var updateSampleGroup = new Konva.Group();

    var aa;
    function updateSample(textpara,fontfamily,textsize,bold,italic,weight) {
        var f = text(textpara,fontfamily,textsize,bold,italic,weight)
        updateSampleLayer.clearBeforeDraw(true);
        updateSampleLayer.clearCache();
        updateSampleGroup.destroy();
        updateSampleLayer.draw();
        var q = 9;
        if (q >= 10) {
            q = 5
        }
        var g = applyDeselRatio(q);
        var d = Math.ceil(updateSampleStage.width() / g);
        var p = Math.ceil(updateSampleStage.height() / q);
        var o = Math.max(0, Math.floor((f.width - d) / 2));
        var m = Math.max(0, Math.floor((f.height - p) / 2));
        var j = Math.min(f.width, 1 + Math.ceil((f.width + d) / 2));
        var h = Math.min(f.height, 1 + Math.ceil((f.height + p) / 2));
        var b = Math.floor(updateSampleStage.width() / 2 - g * f.width / 2);
        var a = Math.floor(updateSampleStage.height() / 2 - q * f.height / 2);
        for (var l = m; l < h; l++) {
            var k = (false && (l & 1)) ? Math.round(g / 2) : 0;
            for (var n = o; n < j; n++) {
                var e = (l * f.width + n) * 4;

                var fillStyle = f.data[e + 3] == 255 ? "#000000" : "#ffffff";
                var complexText = new Konva.Text({
                  x: b + n * g + k,
                  y: a + l * q,
                  text: 'X',
                  fill: fillStyle,
                  align: 'center',
                });
                updateSampleGroup.add(complexText);
            }
        }
        updateSampleLayer.add(updateSampleGroup);
        updateSampleLayer.draw();
        updateSampleStage.draw();
    }

    var hiddenSampleStage = new Konva.Stage({
     container: 'textSample1',
     width: 50 * gridSize,
     height: canvasWidth * gridSize,
     visible: false
    });
    var hiddenSampleLayer = new Konva.Layer();
    hiddenSampleStage.add(hiddenSampleLayer);
    var hiddenSampleGroup = new Konva.Group({});

    function updateSample1(textpara,fontfamily,textsize,bold,italic,weight) {
        var f = text(textpara,fontfamily,textsize,bold,italic,weight)
        hiddenSampleLayer.clearBeforeDraw(true);
        hiddenSampleLayer.clearCache();
        hiddenSampleGroup.destroy();
        hiddenSampleLayer.draw();
        var q = 25;
        var g = applyDeselRatio(q);
        var d = Math.ceil(hiddenSampleStage.width() / g);
        var p = Math.ceil(hiddenSampleStage.height() / q);
        var o = Math.max(0, Math.floor((f.width - d) / 2));
        var m = Math.max(0, Math.floor((f.height - p) / 2));
        var j = Math.min(f.width, 1 + Math.ceil((f.width + d) / 2));
        var h = Math.min(f.height, 1 + Math.ceil((f.height + p) / 2));
        var b = Math.floor(hiddenSampleStage.width() / 2 - g * f.width / 2);
        var a = Math.floor(hiddenSampleStage.height() / 2 - q * f.height / 2);
        for (var l = m; l < h; l++) {
            var k = (false && (l & 1)) ? Math.round(g / 2) : 0;
            for (var n = o; n < j; n++) {
                var e = (l * f.width + n) * 4;

                var fillStyle = f.data[e + 3] == 255 ? "#000000" : "#ffffff";
                var complexText = new Konva.Text({
                  x: b + n * g + k,
                  y: a + l * q,
                  text: 'X',
                  fill: fillStyle,
                  align: 'center',
                });
                hiddenSampleGroup.add(complexText);
            }
        }
        hiddenSampleLayer.add(hiddenSampleGroup);
        hiddenSampleLayer.draw();
        hiddenSampleStage.draw();
    }

    $("#cloneSampleText").click(function(){
      $( hiddenSampleGroup.children ).each(function(key, val) {
        if(val.attrs.fill === '#ffffff')
           {
             val.destroy();
             hiddenSampleLayer.draw();
           }
           val.fontSize(18);
           var xx = val.attrs.x-7, yy = val.attrs.y+4;
           val.attrs.x = xx;
           val.attrs.y = yy;
           val.attrs.fill = 'red'
         });
      aa = hiddenSampleGroup.clone({x:0,y:0,name:'sampleGroupCloned'});

      newfunction(aa);
      //
      $('.close').click();
    })
var toAnimate = true;
function newfunction(aa)
{
        var canvasPos = getPosition(stage);
        var mouseX = 0;
        var mouseY = 0;
        canvasGridLayer.addEventListener("mousemove", function setMousePosition(e){
          mouseX = e.clientX - canvasPos.x;
          mouseY = e.clientY - canvasPos.y;
          if(toAnimate){
            update(mouseX,mouseY,aa);
          }
        }, false);
        canvasGridLayer.addEventListener("click", stopfollow, false);
}
function update(mouseX,mouseY,aa) {
  // canvasGridLayer.clearBeforeDraw(true);
  // canvasGridLayer.clearCache();
  // $(canvasGridLayer.children).each(function(key, val){
  //   if(val.attrs.name === "textgrup"){
  //     val.destroy();
  //   }
  // })
  // canvasGridLayer.draw();

  //var bb = aa.clone({x:mouseX,y:mouseY});
  var group22 = new Konva.Group({aa});


      // aa.attrs.x= mouseX;
      // aa.attrs.y = mouseY;
      canvasGridLayer.add(group22);
      canvasGridLayer.draw();
      stage.batchDraw();
      console.log(canvasGridLayer)
}
function stopfollow(e){
    toAnimate = false;
    // var groups = stage.find(node => {
    //  return node.getType() === 'Group';
    // });
    // var RectList = canvasGridLayer.find("Rect");
    // console.log(groups);
    // $( groups).each(function(key, val) {
    //
    //   if(val.attrs.name === "sampleGroupCloned")
    //      {
    //        console.log(1312321)
    //        val.position({
    //          x: Math.round(val.x() / gridSize) * gridSize,
    //          y: Math.round(val.y() / gridSize) * gridSize
    //        });
    //        stage.batchDraw();
    //        $( val.children ).each(function(key, ctextval) {
    //        $( RectList ).each(function(key, rectval) {
    //
    //         if(rectval.attrs.x == ctextval.x() && rectval.attrs.y == ctextval.y())
    //           {
    //             rectval.attrs.filled = true;
    //           }
    //         });
    //       });
    //
    //
    //      }
    // });
}
      function getPosition(el)
      {
            var xPosition = 0;
            var yPosition = 0;

            var offsetLeft = el.content.offsetLeft;
            var scrollLeft = el.content.scrollLeft;
            var clientLeft = el.content.clientLeft;

            var offsetTop = el.content.offsetTop;
            var scrollTop = el.content.scrollTop;
            var clientTop = el.content.clientTop;

            var offsetParent = el.content.offsetParent;

            while (el) {
              // console.log(el)
              xPosition += (offsetLeft - scrollLeft + clientLeft);
              yPosition += (offsetTop - scrollTop + clientTop);
              el = offsetParent;
              break;
            }
            return {
              x: xPosition,
              y: yPosition
            };
        }


    hiddenSampleGroup.on('dragstart', function(e) {

      hiddenSampleGroup.visible(true);
    });
    hiddenSampleGroup.on('dragend', function() {
      var groups = stage.find(node => {
       return node.getType() === 'Group';
      });
      var RectList = canvasGridLayer.find("Rect");

      $( groups).each(function(key, val) {
        if(val.attrs.name === "sampleGroupCloned")
           {
             val.position({
               x: Math.round(val.x() / gridSize) * gridSize,
               y: Math.round(val.y() / gridSize) * gridSize
             });
             stage.batchDraw();
             val.draggable(false)
             $( val.children ).each(function(key, ctextval) {
             $( RectList ).each(function(key, rectval) {

              if(rectval.attrs.x == ctextval.x() && rectval.attrs.y == ctextval.y())
                {
                  rectval.attrs.filled = true;
                }
              });
            });


           }
      });

    });
    /*  Text popup ends here  */

}

function nearest(value, min, max){
  if((value-min)>(max-value)){
      return max;
   } else {
    return min;
   }
}

/*  Text tool functions  */
function applyDeselRatio(b) {
var deselRatio = 1;
    var a = b * deselRatio;
    if (deselRatio >= 1) {
        a = Math.floor(a)
    } else {
        a = Math.ceil(a)
    }
    return a
}
function text(textpara, b, m, h, g,weight)
{
  this.canvas = document.createElement("canvas");
  this.canvas.width = 200;
  this.canvas.height = 200;
  this.ctx = this.canvas.getContext("2d")

  this.ctx.clearRect(0, 0, 600, 600);
  this.ctx.fillStyle = "#000000";
  var d = fontSpec(b, m, h, g);
  this.ctx.font = d;
  var c = this.ctx.measureText(textpara);
  var p = getTextHeight(d);
  this.ctx.fillText(textpara, 0, p.ascent);

  var k = Math.max(1, c.width);
  var e = this.ctx.getImageData(0, 0, k, p.height);

  var n = 600;
  var j = 0;
  for (var f = 3; f < e.data.length; f += 4) {

      var a = 0;
      if (e.data[f] >= weight) {
          a = 255;
          var l = (f / 4) % k;
          n = Math.min(n, l);
          j = Math.max(j, l)
      }
      e.data[f] = a
  }
  this.textWidth = 1 + j - n;
  if (this.textWidth > 580) {
      this.textWidth = c.width
  }
  return e
}
function fontSpec(e, d, c, b) {
    var a = "";
    if (b) {
        a += "italic "
    }
    if (c) {
        a += "bold "
    }
    return a + d + "px " + e
}

function getTextHeight(c) {
    var e = $('<span style="font: ' + c + '">Hg</span>');
    var d = $('<div style="display: inline-block; width: 1px; height: 0px;"></div>');
    var f = $("<div></div>");
    f.append(e, d);
    var b = $("body");
    b.append(f);
    try {
        var a = {};
        d.css({
            verticalAlign: "baseline"
        });
        a.ascent = d.offset().top - e.offset().top;
        d.css({
            verticalAlign: "bottom"
        });
        a.height = d.offset().top - e.offset().top;
        a.descent = a.height - a.ascent
    } finally {
        f.remove()
    }
    return a
}




/*
      ===============================
      initiate canvas on window load
      ===============================
*/
$( window ).on( "load", function() {
    /* Canvas initiate funtion with parameters
      * Parameter1 : Initial canvas main background color.
      * Parameter2 : Grid stroke color.
      * Parameter3 : Grid shadow color.
      * Parameter4 : Circle stroke color.
      * Parameter5 : Circle Fill color.
      * Parameter6 : Text Fill color
      */
    canvasInit('white','#FFE793','#FFE9AD','#F7976F','#FED376','#000000');
});

/*  Code for the select and drag designs starts here!  */
function startDrag(posIn){
  posStart = {x: posIn.x, y: posIn.y};
  posNow = {x: posIn.x, y: posIn.y};
}

function reverse(r1, r2){
  var r1x = r1.x, r1y = r1.y, r2x = r2.x,  r2y = r2.y, d;
  if (r1x > r2x ){
    d = Math.abs(r1x - r2x);
    r1x = r2x; r2x = r1x + d;
  }
  if (r1y > r2y ){
    d = Math.abs(r1y - r2y);
    r1y = r2y; r2y = r1y + d;
  }
    return ({x1: r1x, y1: r1y, x2: r2x, y2: r2y}); // return the corrected rect.
}
/*  Code for the select and drag designs ends here!  */

$(function()
{
/*
    ====================================================
    Pass colors to canvasInit function from color pattel
    ====================================================
*/
$(document).on('click', '.color_pattel',function() {
  canvasBgColor = $(this).data("colorcode");
  var colorType     =  $(this).data("type");
  if(colorType == "white" || colorType == "black")        // set default colors if bg is of white or black color
  {
    gridStrokeCPara = '#FFE793';
    gridShadowCPara = '#FFE9AD';
    circleStrokeCPara = '#F7976F';
    circleFillCPara = '#FED376';
  }
  else if(colorType == 'light')     // generate and set 20% darker shade if bg is of light color
  {
      // Create a 20% darker shade of light color
      gridStrokeCPara = ColorLuminance(canvasBgColor, -0.2);
      gridShadowCPara = ColorLuminance(gridStrokeCPara, -0.2);
      circleStrokeCPara = ColorLuminance(gridShadowCPara, -0.2);
      circleFillCPara = ColorLuminance(circleStrokeCPara, -0.2);
  }
  else                             // generate and set 100% lighter shade if bg is of dark color
  {
    // Create a 100% lighter shade of dark color
    gridStrokeCPara = ColorLuminance(canvasBgColor, 0.10);
    gridShadowCPara = ColorLuminance(gridStrokeCPara, 0.10);
    circleStrokeCPara = ColorLuminance(gridShadowCPara, 0.10);
    circleFillCPara = ColorLuminance(circleStrokeCPara, 0.10);
  }
  canvasInit(canvasBgColor,gridStrokeCPara,gridShadowCPara,circleStrokeCPara,circleFillCPara);
  // Call to canvasInit function
});

/*
    ============================================
    Generate new color codes script starts here!
    =============================================
*/
function ColorLuminance(hex, lum)
{
  // validate hex string
	hex = String(hex).replace(/[^0-9a-f]/gi, '');

	if (hex.length < 6) {
		hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
	}
	lum = lum || 0;

	// convert to decimal and change luminosity
	var rgb = "#", c, i;
	for (i = 0; i < 3; i++) {
		c = parseInt(hex.substr(i*2,2), 16);
		c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
		rgb += ("00"+c).substr(c.length);
	}
	return rgb;
}
/*  Generate new color codes script ends here!  */
});



$(document).ready(function() {




});
</script>
<style>
.slidecontainer {
    width: 100%;
}

.slider {
    -webkit-appearance: none;
    width: 100%;
    height: 15px;
    border-radius: 5px;
    background: #d3d3d3;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
}

.slider:hover {
    opacity: 1;
}

.slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: #4CAF50;
    cursor: pointer;
}

.slider::-moz-range-thumb {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: #4CAF50;
    cursor: pointer;
}
</style>
<div class="col-md-12 canvas_container">
                    <div class="col-md-6 float-left canvas_content">
                        <div id="canvas"></div>
                    </div>
                    <div class="col-md-2">
                        <h3>Toolbar Section</h3>
                        <ul class="toolbar_list" id="">
                            <li class="canvas_tool active" id="pencil" data-mode="pencil" title="pencil">
                                <i class="fa fa-pencil" aria-hidden="true"></i>
                            </li>
                            <li class="canvas_tool" id="eraser" data-mode="eraser" title="eraser">
                                <i class="fa fa-eraser" aria-hidden="true"></i>
                            </li>
                            <li class="canvas_tool" id="select_shape" data-mode="select_shape" title="Select Shape">
                              <img src="select.png" alt="select shape"/>
                            </li>
                            <li class="canvas_tool" id="back_stich" data-mode="back_stich" title="Back Stich">
                              <img src="back_stich.png" alt="Back Stich" width='54px' height='41px' />
                            </li>
                            <li class="canvas_tool" id="text_modal" data-mode="toolText" title="Text" data-toggle="modal" data-target="#textModal" data-backdrop="false" >
                                <i class="fa fa-text-width" aria-hidden="true"></i>
                            </li>
                            <li class="canvas_tool" id="refresh_canvas" data-mode="refresh" title="Refresh">
                                <i class="fa fa-refresh" aria-hidden="true"></i>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-4 float-left canvas_tool_bar">
                      <h3>Canvas Colors Section</h3>
                        <p class="font-weight-bold text-left">
                          Click to change canvas background color
                          <button class="btn btn-success show-colors-btn" data-toggle="collapse" data-target="#pattel_container"> + </button>
                        </p>
                        <div class="color_pattel_container collapse text-left" id="pattel_container">
                            <ul class="my-new-list">
                              <li class="color_pattel" data-floss="150" id="150" data-type="dark" data-colorcode="#AB0249" style="background-color:#AB0249"> </li>
                              <li class="color_pattel" data-floss="151" id="151" data-type="light" data-colorcode="#F0CED4" style="background-color:#F0CED4"> </li>
                              <li class="color_pattel" data-floss="152" id="152" data-type="light" data-colorcode="#E2A099" style="background-color:#E2A099"> </li>
                              <li class="color_pattel" data-floss="153" id="153" data-type="light" data-colorcode="#E6CCD9" style="background-color:#E6CCD9"> </li>
                              <li class="color_pattel" data-floss="154" id="154" data-type="dark" data-colorcode="#572433" style="background-color:#572433"> </li>
                              <li class="color_pattel" data-floss="155" id="155" data-type="dark" data-colorcode="#9891B6" style="background-color:#9891B6"> </li>
                              <li class="color_pattel" data-floss="156" id="156" data-type="light" data-colorcode="#A3AED1" style="background-color:#A3AED1"> </li>
                              <li class="color_pattel" data-floss="157" id="157" data-type="light" data-colorcode="#BBC3D9" style="background-color:#BBC3D9"> </li>
                              <li class="color_pattel" data-floss="158" id="158" data-type="dark" data-colorcode="#4C526E" style="background-color:#4C526E"> </li>
                              <li class="color_pattel" data-floss="159" id="159" data-type="light" data-colorcode="#C7CAD7" style="background-color:#C7CAD7"> </li>
                              <li class="color_pattel" data-floss="160" id="160" data-type="light" data-colorcode="#999FB7" style="background-color:#999FB7"> </li>
                              <li class="color_pattel" data-floss="161" id="161" data-type="dark" data-colorcode="#7880A4" style="background-color:#7880A4"> </li>
                              <li class="color_pattel" data-floss="162" id="162" data-type="light" data-colorcode="#DBECF5" style="background-color:#DBECF5"> </li>
                              <li class="color_pattel" data-floss="163" id="163" data-type="dark" data-colorcode="#4D8361" style="background-color:#4D8361"> </li>
                              <li class="color_pattel" data-floss="164" id="164" data-type="light" data-colorcode="#C8D8B8" style="background-color:#C8D8B8"> </li>
                              <li class="color_pattel" data-floss="165" id="165" data-type="light" data-colorcode="#EFF4A4" style="background-color:#EFF4A4"> </li>
                              <li class="color_pattel" data-floss="166" id="166" data-type="light" data-colorcode="#C0C840" style="background-color:#C0C840"> </li>
                              <li class="color_pattel" data-floss="167" id="167" data-type="dark" data-colorcode="#A77C49" style="background-color:#A77C49"> </li>
                              <li class="color_pattel" data-floss="168" id="168" data-type="light" data-colorcode="#D1D1D1" style="background-color:#D1D1D1"> </li>
                              <li class="color_pattel" data-floss="169" id="169" data-type="light" data-colorcode="#848484" style="background-color:#848484"> </li>
                              <li class="color_pattel" data-floss="208" id="208" data-type="dark" data-colorcode="#835B8B" style="background-color:#835B8B"> </li>
                              <li class="color_pattel" data-floss="209" id="209" data-type="dark" data-colorcode="#A37BA7" style="background-color:#A37BA7"> </li>
                            </ul>
                        </div>

                        <p class="font-weight-bold text-left">
                          Click to change text color
                          <button class="btn btn-success show-text-colors-btn" data-toggle="collapse" data-target="#text_pattel_container"> + </button>
                        </p>
                        <div class="text_color_pattel_container collapse text-left" id="text_pattel_container">
                            <ul class="text-color-list">
                                  <li class="text_color_pattel" data-floss="150" id="150" data-type="dark" data-colorcode="#AB0249" style="background-color:#AB0249">
                                  </li>
                                  <li class="text_color_pattel" data-floss="151" id="151" data-type="light" data-colorcode="#F0CED4" style="background-color:#F0CED4"> </li>
                                  <li class="text_color_pattel" data-floss="152" id="152" data-type="light" data-colorcode="#E2A099" style="background-color:#E2A099"> </li>
                                  <li class="text_color_pattel" data-floss="153" id="153" data-type="light" data-colorcode="#E6CCD9" style="background-color:#E6CCD9"> </li>
                                  <li class="text_color_pattel" data-floss="154" id="154" data-type="dark" data-colorcode="#572433" style="background-color:#572433"> </li>
                                  <li class="text_color_pattel" data-floss="155" id="155" data-type="dark" data-colorcode="#9891B6" style="background-color:#9891B6"> </li>
                                  <li class="text_color_pattel" data-floss="156" id="156" data-type="light" data-colorcode="#A3AED1" style="background-color:#A3AED1"> </li>
                                  <li class="text_color_pattel" data-floss="157" id="157" data-type="light" data-colorcode="#BBC3D9" style="background-color:#BBC3D9"> </li>
                                  <li class="text_color_pattel" data-floss="158" id="158" data-type="dark" data-colorcode="#4C526E" style="background-color:#4C526E"> </li>
                                  <li class="text_color_pattel" data-floss="159" id="159" data-type="light" data-colorcode="#C7CAD7" style="background-color:#C7CAD7"> </li>
                                  <li class="text_color_pattel" data-floss="160" id="160" data-type="light" data-colorcode="#999FB7" style="background-color:#999FB7"> </li>
                                  <li class="text_color_pattel" data-floss="161" id="161" data-type="dark" data-colorcode="#7880A4" style="background-color:#7880A4"> </li>
                                  <li class="text_color_pattel" data-floss="162" id="162" data-type="light" data-colorcode="#DBECF5" style="background-color:#DBECF5"> </li>
                                  <li class="text_color_pattel" data-floss="163" id="163" data-type="dark" data-colorcode="#4D8361" style="background-color:#4D8361"> </li>
                                  <li class="text_color_pattel" data-floss="164" id="164" data-type="light" data-colorcode="#C8D8B8" style="background-color:#C8D8B8"> </li>
                                  <li class="text_color_pattel" data-floss="165" id="165" data-type="light" data-colorcode="#EFF4A4" style="background-color:#EFF4A4"> </li>
                                  <li class="text_color_pattel" data-floss="166" id="166" data-type="light" data-colorcode="#C0C840" style="background-color:#C0C840"> </li>
                                  <li class="text_color_pattel" data-floss="167" id="167" data-type="dark" data-colorcode="#A77C49" style="background-color:#A77C49"> </li>
                                  <li class="text_color_pattel" data-floss="168" id="168" data-type="light" data-colorcode="#D1D1D1" style="background-color:#D1D1D1"> </li>
                                  <li class="text_color_pattel" data-floss="169" id="169" data-type="light" data-colorcode="#848484" style="background-color:#848484"> </li>
                                </ul>
                        </div>

                        <!-- <p>Grid Width: <input type="text" id="grid_width" value="20" onkeyup="grid_width_change()"></p>
                        <p>Grid Height: <input type="text" id="grid_height" value="20" onkeyup="grid_height_change()"></p>
                        <button onclick="restart();"  title="Clears this grid">Clear</button>
                    </div> -->
                </div>
</div>

            <!-- Modal -->
            <div id="textModal" class="modal fade">
                <div class="modal-dialog">
                    <div class="col-md-12 modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                             <h4 class="modal-title">Draw Text</h4>

                        </div>
                        <div class="modal-body">
                          <form class="form-horizontal">
                          <div class="form-group">
                                <label class="control-label col-sm-2" for="email">Text</label>
                                <div class="col-sm-10">
                                  <input type="text" class="form-control" id="textfill" autofocus>
                                </div>
                            </div>
                              <div class="form-group">
                                <label class="control-label col-sm-2" for="pwd">Font:</label>
                                <div class="col-sm-10">
                                  <select id="textFontSelect">
                                    <option value="sans-serif" style="font-family:'sans-serif';">sans-serif</option>
                                    <option value="serif" style="font-family:'serif';">serif</option>
                                    <option value="monospace" style="font-family:'monospace';">monospace</option>
                                    <option value="American Typewriter" style="font-family:'American Typewriter';">American Typewriter</option>
                                    <option value="Andale Mono" style="font-family:'Andale Mono';">Andale Mono</option>
                                    <option value="Apple Chancery" style="font-family:'Apple Chancery';">Apple Chancery</option>
                                    <option value="Arial" style="font-family:'Arial';">Arial</option>
                                    <option value="Arial Black" style="font-family:'Arial Black';">Arial Black</option>
                                    <option value="Baskerville" style="font-family:'Baskerville';">Baskerville</option>
                                    <option value="Big Caslon" style="font-family:'Big Caslon';">Big Caslon</option>
                                    <option value="Charter" style="font-family:'Charter';">Charter</option>
                                    <option value="Comic Sans MS" style="font-family:'Comic Sans MS';">Comic Sans MS</option>
                                    <option value="Copperplate" style="font-family:'Copperplate';">Copperplate</option>
                                    <option value="Courier" style="font-family:'Courier';">Courier</option>
                                    <option value="Courier New" style="font-family:'Courier New';">Courier New</option>
                                    <option value="cursive" style="font-family:'cursive';">cursive</option>
                                    <option value="fantasy" style="font-family:'fantasy';">fantasy</option>
                                    <option value="Futura" style="font-family:'Futura';">Futura</option>
                                    <option value="Georgia" style="font-family:'Georgia';">Georgia</option>
                                    <option value="Gill Sans" style="font-family:'Gill Sans';">Gill Sans</option>
                                    <option value="Helvetica" style="font-family:'Helvetica';">Helvetica</option>
                                    <option value="Herculanum" style="font-family:'Herculanum';">Herculanum</option>
                                    <option value="Hoefler Text" style="font-family:'Hoefler Text';">Hoefler Text</option>
                                    <option value="Impact" style="font-family:'Impact';">Impact</option>
                                    <option value="Lucida Grande" style="font-family:'Lucida Grande';">Lucida Grande</option>
                                    <option value="Marker Felt" style="font-family:'Marker Felt';">Marker Felt</option>
                                    <option value="Optima" style="font-family:'Optima';">Optima</option>
                                    <option value="Osaka" style="font-family:'Osaka';">Osaka</option>
                                    <option value="Palatino" style="font-family:'Palatino';">Palatino</option>
                                    <option value="Papyrus" style="font-family:'Papyrus';">Papyrus</option>
                                    <option value="Skia" style="font-family:'Skia';">Skia</option>
                                    <option value="Symbol" style="font-family:'Symbol';">Symbol</option>
                                    <option value="Tahoma" style="font-family:'Tahoma';">Tahoma</option>
                                    <option value="Times" style="font-family:'Times';">Times</option>
                                    <option value="Times New Roman" style="font-family:'Times New Roman';">Times New Roman</option>
                                    <option value="Trebuchet MS" style="font-family:'Trebuchet MS';">Trebuchet MS</option>
                                    <option value="Verdana" style="font-family:'Verdana';">Verdana</option>
                                    <option value="Webdings" style="font-family:'Webdings';">Webdings</option>
                                    <option value="Zapf Dingbats" style="font-family:'Zapf Dingbats';">Zapf Dingbats</option>
                                    <option value="Zapfino" style="font-family:'Zapfino';">Zapfino</option>
                                  </select>
                                </div>
                              </div>
                              <div class="form-group">
                                <label class="control-label col-sm-2" for="pwd">Size:</label>
                                <div class="col-sm-10">
                                  <input type="number" class="form-control" id="textFontsize" value="12">
                                </div>
                              </div>
                              <div class="form-group">
                                <label class="control-label col-sm-2" for="pwd">Bold:</label>
                                <div class="col-sm-10">
                                  <input type="checkbox" name='bold' id='textFontBold'/>
                                </div>
                              </div>
                              <div class="form-group">
                                <label class="control-label col-sm-2" for="pwd">Italic:</label>
                                <div class="col-sm-10">
                                  <input type="checkbox" name='italic' id='textFontItalic'/>
                                </div>
                              </div>
                              <div class="form-group">
                                <label class="control-label col-sm-2" for="pwd">Weight:</label>
                                <div class="col-sm-10">
                                  <div class="slidecontainer">
                                    <input type="range" min="1" max="100" value="80" class="slider" id="myRange">
                                    <p>Value: <span id="demo"></span></p>
                                  </div>
                                </div>
                              </div>
                              <div class="form-group">
                                <label class="control-label col-sm-2" for="pwd">Sample:</label>
                                <div class="col-sm-10">
                                  <!-- <canvas id="textSample" width="300" height="100" style="border:1px solid #ccc;">
                                  </canvas> -->
                                  <div id="textSample"></div>
                                  <div id="textSample1" style="display:none;"></div>
                                </div>
                              </div>

                            </form>
                        </div>
                        <div class="modal-footer">
                            <button id="cloneSampleText" type="button" class="btn btn-primary">Ok</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
